from typing import List, Dict

import streamlit as st


PROG_KEY = "__progress_items__"
_CSS_KEY = "__progress_css_injected__"
_PH_KEY = "__progress_placeholder__"


def _ensure():
    if PROG_KEY not in st.session_state:
        st.session_state[PROG_KEY] = []  # list of {label,status}


def reset_progress():
    st.session_state[PROG_KEY] = []


def add_step(label: str, status: str = "running") -> int:
    _ensure()
    st.session_state[PROG_KEY].append({"label": label, "status": status})
    return len(st.session_state[PROG_KEY]) - 1


def update_step(index: int, status: str | None = None, label: str | None = None):
    _ensure()
    if 0 <= index < len(st.session_state[PROG_KEY]):
        if status is not None:
            st.session_state[PROG_KEY][index]["status"] = status
        if label is not None:
            st.session_state[PROG_KEY][index]["label"] = label


def _normalize(text: str) -> str:
    # Normalize different dash characters and excess whitespace for robust matching
    if not isinstance(text, str):
        text = str(text)
    for ch in ("—", "–", "−"):
        text = text.replace(ch, "-")
    # Collapse multiple spaces around dashes
    text = " ".join(text.split())
    return text.strip()


def remove_steps_by_prefix(prefix: str):
    """Remove all progress steps whose label starts with prefix.

    Matching is dash/whitespace tolerant to avoid Unicode/spacing mismatches.
    """
    _ensure()
    items = st.session_state.get(PROG_KEY, [])
    norm_prefix = _normalize(prefix)
    kept = []
    for it in items:
        lbl = _normalize(it.get("label", ""))
        if not lbl.startswith(norm_prefix):
            kept.append(it)
    st.session_state[PROG_KEY] = kept


def prune_completed(max_items: int = 4):
    """Keep the sidebar tidy by trimming older completed entries.

    - Always keep all running/active items.
    - Among completed items, keep the most recent ones so that
      total items <= max_items.
    """
    _ensure()
    items = st.session_state.get(PROG_KEY, [])
    running = [it for it in items if (it.get("status", "").lower() == "running")]
    completed = [it for it in items if (it.get("status", "").lower() == "done")]
    # Keep the most recent completed entries up to the remaining slots
    remaining_slots = max(0, max_items - len(running))
    completed_kept = completed[-remaining_slots:] if remaining_slots < len(completed) else completed
    st.session_state[PROG_KEY] = running + completed_kept


def render_sidebar():
    _ensure()
    items: List[Dict[str, str]] = st.session_state.get(PROG_KEY, [])
    if not items:
        # Clear prior placeholder if present so the block disappears when empty
        ph = st.session_state.get(_PH_KEY)
        if ph is not None:
            try:
                ph.empty()
            except Exception:
                pass
        return
    # Create or reuse a single placeholder in the sidebar and clear it
    ph = st.session_state.get(_PH_KEY)
    if ph is None:
        ph = st.sidebar.empty()
        st.session_state[_PH_KEY] = ph
    else:
        try:
            ph.empty()
        except Exception:
            pass
    with ph.container():
        st.markdown("### Working")
        # Inject lightweight animation styles once
        if not st.session_state.get(_CSS_KEY):
            st.markdown(
                """
                <style>
                .agent-row{display:flex;align-items:center;gap:8px;margin:2px 0;}
                .agent-label{flex:1;}
                .pulse-dot{width:8px;height:8px;border-radius:999px;background:var(--acc1,#0b6cf0);
                           box-shadow:0 0 0 0 rgba(11,108,240,.6);animation:pulse 1.5s infinite;}
                @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(11,108,240,.6);}70%{box-shadow:0 0 0 9px rgba(11,108,240,0);}100%{box-shadow:0 0 0 0 rgba(11,108,240,0);}}
                .done-dot{color:#16a34a;}
                .done-dot, .done-dot * {color:#16a34a !important}
                .fail-dot{color:#dc2626;}
                </style>
                """,
                unsafe_allow_html=True,
            )
            st.session_state[_CSS_KEY] = True
        for it in items:
            raw_label = it.get("label", "…")
            label = raw_label or "…"
            status = (it.get("status") or "").lower()
            if status == "done":
                # Enforce green check and append " — Done" once
                if not label.rstrip().endswith("Done"):
                    label = f"{label} — Done"
                html = (
                    "<div class='agent-row'>"
                    "<span class='done-dot' style='color:#16a34a !important' aria-label='done'>✓</span>"
                    f"<span class='agent-label'>{label}</span>"
                    "</div>"
                )
            elif status == "running":
                html = (
                    "<div class='agent-row'>"
                    "<span class='pulse-dot' aria-label='running'></span>"
                    f"<span class='agent-label'>{label}</span>"
                    "</div>"
                )
            else:
                html = (
                    "<div class='agent-row'>"
                    "<span class='fail-dot' aria-label='failed'>×</span>"
                    f"<span class='agent-label'>{label}</span>"
                    "</div>"
                )
            st.markdown(html, unsafe_allow_html=True)


__all__ = [
    "reset_progress",
    "add_step",
    "update_step",
    "remove_steps_by_prefix",
    "prune_completed",
    "render_sidebar",
]



